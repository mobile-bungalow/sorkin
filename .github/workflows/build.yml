name: Build Sorkin Plugin

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [published]

jobs:
  build-linux:
    name: Linux - build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            clang \
            pkg-config \
            libopus-dev \
            libvpx-dev \
            nasm \
            yasm \
            make
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install Just
        uses: extractions/setup-just@v2
      - name: Build
        run: just bundle
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sorkin-linux
          path: target/sorkin_addon/

  build-macos:
    name: macOS - build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install ffmpeg pkg-config

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Just
        uses: extractions/setup-just@v2

      - name: Build
        run: just bundle

      - name: Mac Sign
        uses: ughuuu/godot-cpp-template/.github/actions/sign@add-more-stuff/options-to-build
        with:
          FRAMEWORK_PATH: target/sorkin_addon/addons/sorkin/bin/libsorkin.framework
          SIGN_FLAGS: "--deep"
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_DEV_PASSWORD: ${{ secrets.APPLE_DEV_PASSWORD }}
          APPLE_DEV_ID: ${{ secrets.APPLE_DEV_ID }}
          APPLE_DEV_TEAM_ID: ${{ secrets.APPLE_DEV_TEAM_ID }}
          APPLE_DEV_APP_ID: ${{ secrets.APPLE_DEV_APP_ID }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sorkin-macos
          path: target/sorkin_addon/

  build-windows:
    name: Windows - build
    runs-on: windows-latest
    env:
      RUST_BACKTRACE: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Just
        uses: extractions/setup-just@v2

      - name: Setup LLVM and FFmpeg
        run: |
          $VCINSTALLDIR = $(& "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath)
          Add-Content $env:GITHUB_ENV "LIBCLANG_PATH=${VCINSTALLDIR}\VC\Tools\LLVM\x64\bin`n"
          Invoke-WebRequest "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-shared.7z" -OutFile ffmpeg-release-full-shared.7z
          7z x ffmpeg-release-full-shared.7z
          mkdir ffmpeg
          mv ffmpeg-*/* ffmpeg/
          Write-Host "Setting environment variables..."
          Add-Content $env:GITHUB_ENV "FFMPEG_DIR=${pwd}\ffmpeg`n"
          Add-Content $env:GITHUB_PATH "${pwd}\ffmpeg\bin`n"

      - name: Build
        run: just bundle

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sorkin-windows
          path: target/sorkin_addon/

  merge-artifacts:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: sorkin-linux
          path: temp-linux

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: sorkin-macos
          path: temp-macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: sorkin-windows
          path: temp-windows

      - name: Merge all platforms into unified addon
        run: |
          mkdir -p addons/sorkin/bin

          cp -r assets/sorkin/* addons/sorkin/
          cp assets/sorkin.gdextension addons/sorkin/

          # Copy Linux binary
          if [ -d "temp-linux/addons/sorkin/bin" ]; then
            cp temp-linux/addons/sorkin/bin/*.so addons/sorkin/bin/
          fi

          # Copy Windows binaries (DLL + FFmpeg DLLs)
          if [ -d "temp-windows/addons/sorkin/bin" ]; then
            cp temp-windows/addons/sorkin/bin/*.dll addons/sorkin/bin/
          fi

          # Copy macOS framework
          if [ -d "temp-macos/addons/sorkin/bin" ]; then
            cp -r temp-macos/addons/sorkin/bin/*.framework addons/sorkin/bin/
          fi

          # List what we have
          echo "=== Unified addon structure ==="
          ls -R addons/

      - name: Upload unified addon
        uses: actions/upload-artifact@v4
        with:
          name: sorkin-addon
          path: addons/

  release:
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    needs: [merge-artifacts]
    runs-on: ubuntu-latest
    steps:
      - name: Download unified addon
        uses: actions/download-artifact@v4
        with:
          name: sorkin-addon
          path: addons

      - name: Create release archive
        run: |
          zip -r sorkin-addon.zip addons/

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          files: sorkin-addon.zip
          draft: false
          prerelease: false
